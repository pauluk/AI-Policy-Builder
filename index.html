
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDS Compliant AI Governance & Risk Assessment</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- GDS Design System Theme --- */
        :root {
            --gds-blue: #1D70B8;
            --gds-black: #0B0C0C;
            --gds-grey-1: #F3F2F1;
            --gds-grey-2: #B1B4B6;
            --gds-grey-3: #505A5F;
            --gds-green: #006435;
            --gds-red: #D4351C;
            --gds-white: #FFFFFF;
            --gds-focus-yellow: #FFDD00;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--gds-grey-1);
            color: var(--gds-black);
            margin: 0;
            padding: 24px;
        }
        .page-container {
            display: flex;
            gap: 24px;
        }
        main { flex: 3; background: var(--gds-white); padding: 5px 32px 32px 32px; border: 1px solid var(--gds-grey-2); }
        aside { flex: 1; position: sticky; top: 24px; height: fit-content; background: var(--gds-white); padding: 32px; border: 1px solid var(--gds-grey-2); }
        
        h1 { font-size: 2.5rem; text-align: center; color: var(--gds-black); border-bottom: 10px solid var(--gds-blue); padding-bottom: 15px; }
        .form-section { border-top: 2px solid var(--gds-grey-2); padding-top: 20px; margin-top: 30px; }
        .form-section h2 { display: flex; align-items: center; gap: 12px; font-size: 1.8rem; margin: 0 0 24px 0; color: var(--gds-black); border-bottom: none; }
        .form-section h2 svg { width: 32px; height: 32px; fill: var(--gds-black); }
        h3 { font-size: 1.2rem; color: var(--gds-black); border-bottom: 1px solid var(--gds-grey-2); padding-bottom: 8px; margin-bottom: 15px; }
        
        .form-group { margin-bottom: 24px; }
        label { font-weight: 700; font-size: 1.1rem; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; border: 2px solid var(--gds-black); border-radius: 0; box-sizing: border-box; font-size: 1rem; }
        input[type="text"]:focus, textarea:focus, select:focus { outline: 3px solid var(--gds-focus-yellow); outline-offset: 0; border-color: var(--gds-black); }
        textarea { min-height: 120px; resize: vertical; }

        .icon { display: inline-block; vertical-align: middle; }
        .label-group { display: flex; align-items: center; gap: 8px; margin-bottom: 8px;}
        .help-icon { display: inline-block; width: 22px; height: 22px; border-radius: 50%; background-color: var(--gds-grey-3); color: var(--gds-white); text-align: center; font-weight: bold; line-height: 22px; cursor: pointer; user-select: none; font-size: 0.9rem;}
        .help-text { font-size: 1rem; color: var(--gds-grey-3); margin-top: 8px; background: var(--gds-white); padding: 15px; border-left: 5px solid var(--gds-grey-2); }
        .hidden { display: none; }
        
        .btn-selector-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        .btn-selector { display: flex; align-items: center; gap: 10px; padding: 10px; background-color: var(--gds-grey-1); border: 2px solid var(--gds-grey-1); border-radius: 0; cursor: pointer; transition: all 0.2s ease; text-align: left; font-size: 1rem; font-weight: 700;}
        .btn-selector:hover { border-color: var(--gds-blue); }
        .btn-selector.active { background-color: var(--gds-blue); border-color: var(--gds-blue); color: var(--gds-white); }
        .btn-selector svg { width: 24px; height: 24px; fill: var(--gds-black); transition: fill 0.2s; flex-shrink: 0; }
        .btn-selector.active svg { fill: var(--gds-white); }
        .other-text-input { margin-top: 10px; }
        
        .switch-container { display: flex; align-items: center; gap: 10px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--gds-grey-2); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--gds-blue); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .pill-container { background-color: var(--gds-grey-1); padding: 15px; border: 2px solid var(--gds-grey-2); }
        .slider-group { display: flex; align-items: center; gap: 15px; }
        input[type="range"] {
            --gradient-stop: 50%;
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: linear-gradient(to right, var(--gds-blue) var(--gradient-stop), var(--gds-grey-2) var(--gradient-stop)); border-radius: 0; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: var(--gds-black); border-radius: 0; cursor: pointer; margin-top: -8px; }
        input[type="number"] { width: 80px; text-align: center; font-weight: bold; }
        
        aside h2 { margin-top: 0; text-align: center; }
        #score-container { cursor: pointer; padding: 10px; transition: background-color 0.2s; border: 2px solid transparent; }
        #score-container:hover { border-color: var(--gds-blue); }
        #risk-meter { width: 100%; height: 20px; background: linear-gradient(to right, var(--gds-green), #FFBF47, var(--gds-red)); position: relative; }
        #risk-indicator { position: absolute; top: -5px; width: 4px; height: 30px; background-color: var(--gds-black); transform: translateX(-50%); transition: left 0.5s ease; border: 2px solid var(--gds-white); }
        #risk-summary { text-align: center; margin-top: 10px; }
        #risk-score { font-size: 3em; font-weight: bold; color: var(--gds-black); }
        #risk-level { font-size: 1.2em; font-weight: 700; padding: 4px 12px; color: var(--gds-white); }
        .risk-low { background-color: var(--gds-green); }
        .risk-medium { background-color: #FFBF47; color: var(--gds-black); }
        .risk-high { background-color: var(--gds-red); }
        
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); 
        }
        .modal-overlay:not(.hidden) { display: flex; }
        .modal-content { background: var(--gds-white); padding: 30px; border: 5px solid var(--gds-blue); width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-content h2, .modal-content h3 { color: var(--gds-black); }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 1.5em; font-weight: bold; cursor: pointer; border: none; background: none; }
        #score-breakdown-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #score-breakdown-table th, #score-breakdown-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--gds-grey-2); }
        #score-breakdown-table th { font-weight: 700; }
        #score-breakdown-table .risk-item { color: var(--gds-red); font-weight: 700;}
        #score-breakdown-table .mitigation-item { color: var(--gds-green); font-weight: 700;}
        #prompt-display { background-color: var(--gds-grey-1); border: 2px solid var(--gds-grey-2); padding: 15px; max-height: 40vh; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }

        .action-buttons button { font-size: 1rem; font-weight: 700; width: 100%; padding: 10px; border-radius: 0; border: none; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 0 #000; position: relative; }
        .action-buttons button:active { top: 2px; box-shadow: none; }
        .action-buttons .icon { width: 1.2em; height: 1.2em; }
        #generatePdfBtn, #exportJsonBtn, #importJsonBtn, #generatePromptBtn { background-color: var(--gds-blue); color: var(--gds-white); }
        #generatePdfBtn:hover, #exportJsonBtn:hover, #importJsonBtn:hover, #generatePromptBtn:hover { background-color: #003078; }
        #clearDataBtn { background-color: var(--gds-red); color: var(--gds-white); box-shadow: 0 2px 0 #5f190c;}
        #clearDataBtn:hover { background-color: #9f2715; }

        footer { text-align: center; margin-top: 2rem; padding: 1rem; border-top: 1px solid var(--gds-grey-2); }
        .footer-link { font-size: 1.1rem; font-weight: 700; color: var(--gds-blue); cursor: pointer; text-decoration: underline; }
        
        #certificateTemplate { display: none; /* Other certificate styles... */ }

        @media (max-width: 900px) { .page-container { flex-direction: column; } aside { position: static; } }
    </style>
</head>
<body>

    <div class="page-container">
        <main>
            <form id="assessmentForm" autocomplete="off">
                <h1>GDS Compliant AI Governance & Risk Assessment</h1>
                
                 <div class="form-group">
                    <label for="template-selector">Load Example Template</label>
                    <select id="template-selector">
                        <option value="blank">-- Start a New Assessment --</option>
                        <optgroup label="Core Functions">
                            <option value="finance">Finance: Automated Invoice Processing</option>
                            <option value="accounting">Accounting: Expense Report Auditing</option>
                            <option value="commercials">Commercials: Contract Risk Analysis</option>
                            <option value="estates">Estates: Predictive Maintenance</option>
                        </optgroup>
                        <optgroup label="Additional Scenarios">
                            <option value="hr">HR: CV Screening Assistant</option>
                            <option value="comms">Comms: Social Media Analysis</option>
                            <option value="operations">Operations: FOI Redaction Tool</option>
                            <option value="policy">Policy: Evidence Synthesis Tool</option>
                            <option value="it_helpdesk">IT: Helpdesk Automation</option>
                            <option value="fraud">Fraud: Grant Anomaly Detection</option>
                        </optgroup>
                    </select>
                </div>

                <section class="form-section">
                    <h2>
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        <span>Project Team & Process</span>
                    </h2>
                    <div class="form-group">
                        <label for="initiativeName">Initiative Name</label>
                        <input type="text" id="initiativeName" name="initiativeName" required>
                    </div>
                    <div class="form-group">
                        <label for="projectLead">Project Lead</label>
                        <input type="text" id="projectLead" name="projectLead">
                    </div>
                    <div class="form-group">
                        <label for="responsibleOwner">Designated Responsible Owner (Accountable)</label>
                        <input type="text" id="responsibleOwner" name="responsibleOwner" placeholder="e.g., Head of Department">
                    </div>
                    <div class="form-group">
                        <label for="dpoContact">Data Protection Officer (DPO) Contact</label>
                        <input type="text" id="dpoContact" name="dpoContact">
                    </div>
                     <div class="form-group">
                        <label for="processDescription">Detailed Process Description</label>
                        <textarea id="processDescription" name="processDescription" placeholder="Describe the end-to-end process this initiative automates or enhances..."></textarea>
                    </div>
                </section>
                
                <section class="form-section">
                    <h2>
                        <svg class="icon" viewBox="0 0 24 24"><path d="M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5C13 2.12 11.88 1 10.5 1S8 2.12 8 3.5V5H4c-1.1 0-2 .9-2 2v4h1.5c1.93 0 3.5 1.57 3.5 3.5S5.43 18 3.5 18H2v4c0 1.1.9 2 2 2h4v-1.5c0-1.93 1.57-3.5 3.5-3.5s3.5 1.57 3.5 3.5V22h4c1.1 0 2-.9 2-2v-4h-1.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5H22V13c0-1.1-.9-2-2-2z"/></svg>
                        <span>Technology & Suppliers</span>
                    </h2>
                    <h3>Business Applications</h3>
                    <div id="tech_apps" class="btn-selector-group">
                        <button type="button" id="app_sap" class="btn-selector multi-select">SAP</button>
                        <button type="button" id="app_oracle" class="btn-selector multi-select">Oracle Fusion</button>
                        <button type="button" id="app_workday" class="btn-selector multi-select">Workday</button>
                        <button type="button" id="app_dynamics" class="btn-selector multi-select">MS Dynamics 365</button>
                        <button type="button" id="app_servicenow" class="btn-selector multi-select">ServiceNow</button>
                        <button type="button" id="app_zendesk" class="btn-selector multi-select">Zendesk</button>
                        <button type="button" id="app_atlassian" class="btn-selector multi-select">Atlassian Suite</button>
                        <button type="button" id="app_sharepoint" class="btn-selector multi-select">SharePoint</button>
                        <button type="button" id="app_aws" class="btn-selector multi-select">AWS Platform</button>
                        <button type="button" id="app_gcp" class="btn-selector multi-select">GCP Platform</button>
                        <button type="button" id="app_custom" class="btn-selector multi-select">Custom Web App</button>
                        <button type="button" id="app_other" class="btn-selector multi-select">Other</button>
                    </div>
                    <input type="text" id="app_other_text" name="app_other_text" class="other-text-input hidden" placeholder="Please specify other applications...">
                    
                    <h3 style="margin-top: 20px;">Workflow / RPA Programs</h3>
                     <div id="tech_workflows" class="btn-selector-group">
                        <button type="button" id="wf_powerautomate" class="btn-selector multi-select">Power Automate</button>
                        <button type="button" id="wf_uipath" class="btn-selector multi-select">UiPath</button>
                        <button type="button" id="wf_blueprism" class="btn-selector multi-select">Blue Prism</button>
                        <button type="button" id="wf_script" class="btn-selector multi-select">Custom Script</button>
                        <button type="button" id="wf_other" class="btn-selector multi-select">Other</button>
                    </div>
                    <input type="text" id="wf_other_text" name="wf_other_text" class="other-text-input hidden" placeholder="Please specify other workflow tools...">

                    <h3 style="margin-top: 20px;">AI Models</h3>
                     <div id="tech_ai_models" class="btn-selector-group">
                        <button type="button" id="ai_openai" class="btn-selector multi-select">OpenAI GPT-4/etc</button>
                        <button type="button" id="ai_gemini" class="btn-selector multi-select">Google Gemini</button>
                        <button type="button" id="ai_azure" class="btn-selector multi-select">Azure AI Service</button>
                        <button type="button" id="ai_custom" class="btn-selector multi-select">Custom Trained Model</button>
                        <button type="button" id="ai_other" class="btn-selector multi-select">Other</button>
                    </div>
                    <input type="text" id="ai_other_text" name="ai_other_text" class="other-text-input hidden" placeholder="Please specify other AI models...">
                    
                    <h3 style="margin-top: 20px;">Data Transfer Methods</h3>
                    <div id="tech_transfer" class="btn-selector-group">
                        <button type="button" id="tf_api" class="btn-selector multi-select">API</button>
                        <button type="button" id="tf_sftp" class="btn-selector multi-select">SFTP</button>
                        <button type="button" id="tf_ftp" class="btn-selector multi-select" data-risk="10">FTP</button>
                        <button type="button" id="tf_email" class="btn-selector multi-select" data-risk="10">Email</button>
                        <button type="button" id="tf_post" class="btn-selector multi-select" data-risk="5">Post</button>
                        <button type="button" id="tf_website" class="btn-selector multi-select">Website</button>
                        <button type="button" id="tf_other" class="btn-selector multi-select">Other</button>
                    </div>
                    <input type="text" id="tf_other_text" name="tf_other_text" class="other-text-input hidden" placeholder="Please specify other transfer methods...">
                    <div id="encryptionQuestions" class="hidden" style="margin-top: 20px;">
                        <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="encryptTransit" name="encryptTransit" data-mitigation="15"><span class="slider round"></span></label>
                                <div class="label-group"><label>Is data encrypted in transit?</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="encryptRest" name="encryptRest" data-mitigation="15"><span class="slider round"></span></label>
                                <div class="label-group"><label>Is data encrypted at rest?</label></div>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin-top: 20px;">Supplier & Third-Party Engagement</h3>
                    <div class="form-group">
                        <div class="switch-container">
                            <label class="switch"><input type="checkbox" id="involvesThirdParty" name="involvesThirdParty"><span class="slider round"></span></label>
                            <div class="label-group"><label>Does this process involve any third-party supplier?</label></div>
                        </div>
                    </div>
                    <div id="conditionalSupplierQuestions" class="hidden">
                         <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="onTenderList" name="onTenderList" data-mitigation="15"><span class="slider round"></span></label>
                                <div class="label-group"><label>Is the supplier on an approved government framework or tender list?</label></div>
                            </div>
                        </div>
                         <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="supplierCompliant" name="supplierCompliant" data-mitigation="0"><span class="slider round"></span></label>
                                <div class="label-group"><label>Has the supplier confirmed its data use complies with government policy?</label><span class="help-icon">?</span></div>
                            </div>
                            <p class="help-text hidden">The GCS policy requires that all third-party suppliers have appropriate data sharing and security agreements in place. Answering 'No' to this represents a significant compliance risk.</p>
                        </div>
                    </div>
                </section>

                <section class="form-section">
                    <h2>
                        <svg class="icon" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                        <span>Risk Assessment</span>
                    </h2>
                    
                    <h3>General Risks & Controls</h3>
                    <div class="form-group">
                        <div class="label-group"><label>Data Sensitivity</label><span class="help-icon">?</span></div>
                        <p class="help-text hidden">The sensitivity of the data is a primary driver of risk. Special Category data (e.g., health, biometrics) requires the highest level of scrutiny and a legal basis for processing.</p>
                        <div id="dataType" class="btn-selector-group single-select">
                            <button type="button" class="btn-selector active" data-value="public_0">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                                <span>Public / Open Data</span>
                            </button>
                            <button type="button" class="btn-selector" data-value="internal_10">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                                <span>Internal Operational</span>
                            </button>
                            <button type="button" class="btn-selector" data-value="commercial_25">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
                                <span>Commercially Sensitive</span>
                            </button>
                            <button type="button" class="btn-selector" data-value="personal_30">
                               <svg class="icon" viewBox="0 0 24 24"><path d="M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"/></svg>
                                <span>Personal Data (PII)</span>
                            </button>
                             <button type="button" class="btn-selector" data-value="special_50">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                                <span>Special Category Data</span>
                            </button>
                        </div>
                    </div>
                     <div class="form-group">
                         <div class="switch-container">
                            <label class="switch"><input type="checkbox" id="apiSecured" name="apiSecured" data-mitigation="15"><span class="slider round"></span></label>
                            <div class="label-group"><label>Are all API/integration points secured?</label><span class="help-icon">?</span></div>
                        </div>
                        <p class="help-text hidden">Ensures that data exchanged between systems is protected from interception, using methods like OAuth, API Keys, or mTLS.</p>
                    </div>
                    <div class="form-group">
                        <div class="switch-container">
                            <label class="switch"><input type="checkbox" id="rbacInPlace" name="rbacInPlace" data-mitigation="20"><span class="slider round"></span></label>
                            <div class="label-group"><label>Is Role-Based Access Control (RBAC) in place?</label><span class="help-icon">?</span></div>
                        </div>
                        <p class="help-text hidden">Ensures that users can only access the information and functions essential to their role, minimizing the risk of unauthorized data access or system misuse.</p>
                    </div>
                    <div class="form-group">
                        <div class="switch-container">
                            <label class="switch"><input type="checkbox" id="hasPIIRemoval" name="hasPIIRemoval" data-mitigation="25"><span class="slider round"></span></label>
                            <div class="label-group"><label><b>Rail Guard:</b> Is automated PII removal/anonymisation in place?</label></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="switch-container">
                            <label class="switch"><input type="checkbox" id="staffTraining" name="staffTraining" data-mitigation="10"><span class="slider round"></span></label>
                            <div class="label-group"><label>Have relevant staff been trained on this system?</label></div>
                        </div>
                    </div>

                    <div id="aiSpecificQuestions" class="hidden">
                        <h3 style="margin-top: 30px;">AI Model Specific Risks & Controls</h3>
                        <div class="form-group">
                            <div class="label-group"><label>Nature of Decision-Making</label><span class="help-icon">?</span></div>
                            <p class="help-text hidden">Objective decisions follow clear rules (e.g., invoice matching). Subjective decisions require judgement (e.g., assessing merit), making them far riskier to automate due to the potential for unexplainable or biased outcomes.</p>
                            <div id="decisionNature" class="btn-selector-group single-select">
                                <button type="button" class="btn-selector active" data-value="objective_0">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M8 18h3v-3h2v3h3v-5h-2v-3h-3V7h3V2H8v5h3v3H8v3H6v5h2z"/></svg>
                                    <span>Objective / Rules-Based</span>
                                </button>
                                <button type="button" class="btn-selector" data-value="interpretive_15">
                                   <svg class="icon" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                                    <span>Knowledge-Based</span>
                                </button>
                                <button type="button" class="btn-selector" data-value="subjective_35">
                                   <svg class="icon" viewBox="0 0 24 24"><path d="M12 3c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 14c-2.67 0-8 1.34-8 4v1h16v-1c0-2.66-5.33-4-8-4zm-6.29 1.29c.9-.53 2.06-1.04 3.52-1.39.53-.13 1.08-.2 1.67-.2s1.14.07 1.67.2c1.46.35 2.62.86 3.52 1.39.42.25.64.71.55 1.19-.09.48-.48.82-.95.82H6.69c-.47 0-.86-.34-.95-.82-.09-.48.13-.94.55-1.19z"/></svg>
                                    <span>Subjective / Discretionary</span>
                                </button>
                            </div>
                        </div>
                         <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="publicFacing" name="publicFacing" data-mitigation="0"><span class="slider round"></span></label>
                                <div class="label-group"><label>Are users clearly notified they are interacting with an AI?</label><span class="help-icon">?</span></div>
                            </div>
                             <p class="help-text hidden">A key principle of the GCS policy is transparency. Users must not be misled into thinking they are interacting with a human. Answering 'No' to this is a significant compliance risk.</p>
                        </div>
                        <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="loggingEnabled" name="loggingEnabled" data-mitigation="20"><span class="slider round"></span></label>
                                <div class="label-group"><label>Are all AI-driven decisions and outputs logged for audit?</label><span class="help-icon">?</span></div>
                            </div>
                             <p class="help-text hidden">To ensure accountability, there must be a record of the AI's actions. This is crucial for investigating errors, challenging decisions, and demonstrating compliance.</p>
                        </div>
                         <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="appealMechanism" name="appealMechanism" data-mitigation="20"><span class="slider round"></span></label>
                                <div class="label-group"><label>Is there a clear mechanism for human appeal and redress?</label></div>
                            </div>
                        </div>
                         <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="biasAssessed" name="biasAssessed" data-mitigation="10"><span class="slider round"></span></label>
                                <div class="label-group"><label>Has the source data been assessed for historical bias?</label></div>
                            </div>
                        </div>
                         <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="biasTesting" name="biasTesting" data-mitigation="20"><span class="slider round"></span></label>
                                <div class="label-group"><label>Has the model undergone specific fairness/bias testing?</label><span class="help-icon">?</span></div>
                            </div>
                            <p class="help-text hidden">Beyond assessing source data, this involves actively testing the model's performance across different demographic groups (where applicable) to ensure equitable outcomes.</p>
                        </div>
                         <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="explainability" name="explainability" data-mitigation="15"><span class="slider round"></span></label>
                                <div class="label-group"><label>Is there a method to explain the AI's decisions (XAI)?</label><span class="help-icon">?</span></div>
                            </div>
                             <p class="help-text hidden">For complex models, having technical methods (like LIME or SHAP) to explain why a specific decision was made is a powerful tool for transparency and debugging.</p>
                        </div>
                         <div class="form-group">
                            <div class="switch-container">
                                <label class="switch"><input type="checkbox" id="humanInLoop" name="humanInLoop" data-mitigation="25"><span class="slider round"></span></label>
                                <div class="label-group"><label>Is there meaningful Human-in-the-Loop oversight?</label></div>
                            </div>
                        </div>
                        <div class="form-group pill-container">
                            <div class="label-group"><label for="accuracySlider">Required Accuracy Threshold</label><span class="help-icon">?</span></div>
                            <p class="help-text hidden">Define the minimum acceptable performance. For critical tasks, this should be very high. For low-stakes tasks, a lower accuracy may be acceptable.</p>
                            <div class="slider-group">
                                <input type="range" id="accuracySlider" name="accuracySlider" min="50" max="100" value="95" step="1" data-risk-multiplier="0.3">
                                <input type="number" id="accuracyInput" min="50" max="100" value="95">
                            </div>
                        </div>
                    </div>
                </section>
            </form>
        </main>

        <aside>
            <h2>Risk Analysis</h2>
            <div id="score-container" title="Click to see score breakdown">
                <div id="risk-meter"><div id="risk-indicator" style="left: 0%;"></div></div>
                <div id="risk-summary">
                    <div id="risk-score">0</div>
                    <div id="risk-level">LOW</div>
                </div>
            </div>
            <hr style="border: none; border-top: 1px solid var(--gds-grey-2); margin-top: 20px;">
            <h3>Actions</h3>
            <div class="action-buttons">
                <button id="generatePromptBtn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM12 17.5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5a.75.75 0 01.75-.75zM4.75 12a.75.75 0 01.75-.75h3.5a.75.75 0 010 1.5h-3.5a.75.75 0 01-.75-.75zM15 12a.75.75 0 01.75-.75h3.5a.75.75 0 010 1.5h-3.5a.75.75 0 01-.75-.75zM7.06 7.06a.75.75 0 011.06-1.06l2.475 2.475a.75.75 0 01-1.06 1.06L7.06 7.06zm9.88 9.88a.75.75 0 01-1.06 1.06l-2.475-2.475a.75.75 0 011.06-1.06l2.475 2.475zM7.06 16.94a.75.75 0 01-1.06 1.06L3.525 15.53a.75.75 0 011.06-1.06l2.475 2.475zM15.53 3.525a.75.75 0 011.06 1.06L14.11 7.06a.75.75 0 01-1.06-1.06l2.475-2.475z"/></svg><span>Generate Transparency Prompt</span></button>
                <button id="generatePdfBtn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9.5 15H7.5V9h2c.83 0 1.5.67 1.5 1.5v3c0 .83-.67 1.5-1.5 1.5zm3-2.5h-1.5V9H11v3.5zm3.5 2.5h-1.5V14h1.5v-1h-2.5V9H16c.83 0 1.5.67 1.5 1.5v1.5c0 .83-.67 1.5-1.5 1.5zM4 6H2v14c0 1.1.9 2 2 2h14v-2-H4V6z"/></svg><span>Generate Certificate</span></button>
                <button id="exportJsonBtn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg><span>Export Assessment</span></button>
                <button id="importJsonBtn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg><span>Import Assessment</span></button>
                <hr style="border: none; border-top: 1px solid var(--gds-grey-2); margin: 20px 0;">
                <button id="clearDataBtn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg><span>Clear Saved Data</span></button>
            </div>
        </aside>
    </div>

    <footer style="text-align: center; margin-top: 2rem; padding: 1rem; border-top: 1px solid var(--gds-grey-2);">
        <a id="openTransparencyModal" class="footer-link">Assessment Transparency: How the Score is Calculated</a>
    </footer>

    <div id="scoreModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close" id="modalCloseBtn">&times;</button>
            <h2>Risk Score Transparency Report</h2>
            <p>The total risk score is calculated from the following factors. Mitigations are shown as negative points.</p>
            <table id="score-breakdown-table">
                <thead><tr><th>Factor</th><th>Points</th></tr></thead>
                <tbody id="score-breakdown-body"></tbody>
                <tfoot><tr><th><strong>Total Score</strong></th><th id="total-score-cell"><strong>0</strong></th></tr></tfoot>
            </table>
        </div>
    </div>
    
    <div id="transparencyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close" id="transparencyModalCloseBtn">&times;</button>
            <h2>Assessment Transparency: How the Score is Calculated</h2>
            <p>The risk score is determined by a logical model that considers inherent risks, specific choices, and the presence of critical mitigating controls. It is not just a simple sum of points.</p>
            <h3>1. Inherent Technology Risks</h3>
            <p>A baseline risk is added if the project uses certain technologies, acknowledging their inherent complexity:</p>
            <ul>
                <li><strong>AI Model Usage:</strong> +15 points</li>
                <li><strong>Workflow/RPA Usage:</strong> +5 points</li>
                <li><strong>Data Transfer:</strong> +10 points (plus more for insecure methods)</li>
            </ul>
            <h3>2. Core Risk Drivers</h3>
            <p>The primary drivers of risk are the sensitivity of the data and the nature of the decisions being made. These form the main component of the score.</p>
            <ul>
                <li><strong>Data Sensitivity:</strong> Ranges from +0 for Public Data to +50 for Special Category Data.</li>
                <li><strong>Decision Nature:</strong> Ranges from +0 for Objective tasks to +35 for Subjective/Discretionary decisions.</li>
            </ul>
            <h3>3. Risk Amplifiers (Toxic Combinations)</h3>
            <p>The model's key feature is identifying high-risk combinations where the total risk is greater than the sum of its parts. These add significant penalty points:</p>
            <ul>
                <li><strong>CRITICAL: Special Category Data + Subjective Decision + No Human Oversight</strong> (+40 pts)</li>
                <li><strong>CRITICAL: Sensitive Data Transfer via Unsecured API</strong> (+25 pts)</li>
                <li>Sensitive Data without Role-Based Access Control (+25 pts)</li>
                <li>Sensitive Data not Encrypted at Rest (+20 pts)</li>
                <li>Subjective Decisions without Explainability (XAI) Methods (+15 pts)</li>
            </ul>
            <h3>4. Specific & Compliance Risks</h3>
            <p>Additional points are added for specific compliance failures or high-risk choices:</p>
            <ul>
                <li>Supplier is not confirmed as policy-compliant: +40 points</li>
                <li>Users are not notified they are interacting with an AI: +25 points</li>
                <li>Supplier is not on an approved government framework: +20 points</li>
            </ul>
            <h3>5. Mitigations</h3>
            <p>Finally, points are subtracted for each key control or mitigation you have in place, such as enabling human oversight, implementing security controls, and ensuring transparency.</p>
        </div>
    </div>

    <div id="promptModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close" id="promptModalCloseBtn">&times;</button>
            <h2>Generated Transparency Report Prompt</h2>
            <p>Copy the text below and paste it into a large language model to generate a GDS-compliant HTML transparency report.</p>
            <pre id="prompt-display"><code></code></pre>
            <div class="action-buttons">
                <button id="copyPromptBtn">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    <span>Copy to Clipboard</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="certificateTemplate">
        <div id="certHeader"><h1>AI Governance & Risk Certificate</h1><p>Issued: <span id="certDate"></span></p></div>
        <div id="certDetailsGrid">
            <div><h3>Initiative Details</h3><p><strong>Name:</strong> <span id="certInitiativeName"></span></p><p><strong>Description:</strong> <span id="certProcessDescription"></span></p></div>
            <div><h3>Project Team</h3><p><strong>Project Lead:</strong> <span id="certProjectLead"></span></p><p><strong>Responsible Owner:</strong> <span id="certResponsibleOwner"></span></p><p><strong>DPO Contact:</strong> <span id="certDpoContact"></span></p></div>
            <div id="certTechStack" style="grid-column: 1 / -1;"></div>
        </div>
        <div id="certScoreDisplay"><p>Overall Risk Score</p><div id="certScoreLevel"></div></div>
        <div id="certRationale"><h3>Rationale for Score</h3><ul id="certRationaleList"></ul></div>
        <div id="certFooter"><p>This certificate confirms that a risk assessment has been completed in accordance with the GCS Generative AI Policy and UK Government AI guidelines.</p></div>
    </div>

    <script>
    // FULLY CONSOLIDATED SCRIPT
    document.addEventListener('DOMContentLoaded', function () {
        // --- DOM ELEMENT SELECTION ---
        const form = document.getElementById('assessmentForm');
        const accuracySlider = document.getElementById('accuracySlider');
        const accuracyInput = document.getElementById('accuracyInput');
        const scoreModal = document.getElementById('scoreModal');
        const openModalBtn = document.getElementById('score-container');
        const closeModalBtn = document.getElementById('modalCloseBtn');
        const importInput = document.getElementById('importJsonInput');
        const exportBtn = document.getElementById('exportJsonBtn');
        const importBtn = document.getElementById('importJsonBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const templateSelector = document.getElementById('template-selector');
        const involvesThirdPartySwitch = document.getElementById('involvesThirdParty');
        const conditionalSupplierQuestions = document.getElementById('conditionalSupplierQuestions');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const techTransferGroup = document.getElementById('tech_transfer');
        const encryptionQuestions = document.getElementById('encryptionQuestions');
        const transparencyModal = document.getElementById('transparencyModal');
        const openTransparencyModalBtn = document.getElementById('openTransparencyModal');
        const transparencyModalCloseBtn = document.getElementById('transparencyModalCloseBtn');
        const promptModal = document.getElementById('promptModal');
        const generatePromptBtn = document.getElementById('generatePromptBtn');
        const promptModalCloseBtn = document.getElementById('promptModalCloseBtn');
        const copyPromptBtn = document.getElementById('copyPromptBtn');
        const promptDisplay = document.getElementById('prompt-display');
        const aiSpecificQuestions = document.getElementById('aiSpecificQuestions');

        // --- TEMPLATES DATA ---
        const templates = {
            finance: { initiativeName: "Finance: Automated Invoice Processing", projectLead: "John Doe", responsibleOwner: "Finance Director", dpoContact: "dpo@gov.uk", processDescription: "Automates the extraction of data from incoming PDF vendor invoices, matches them against purchase orders in SAP, and flags discrepancies for human review.", tech_apps: ["app_sap"], tech_workflows: ["wf_powerautomate"], tech_ai_models: ["ai_azure"], app_other_text: "", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: true, onTenderList: true, supplierCompliant: true, dataType: "commercial_25", decisionNature: "objective_0", accuracySlider: "98", publicFacing: false, loggingEnabled: true, appealMechanism: true, biasAssessed: true, biasTesting: true, explainability: false, humanInLoop: true, rbacInPlace: true, hasPIIRemoval: true, apiSecured: true, staffTraining: true, tech_transfer: ["tf_api"], encryptTransit: true, encryptRest: true },
            accounting: { initiativeName: "Accounting: Expense Report Auditing", projectLead: "Jane Smith", responsibleOwner: "Head of Accounting", dpoContact: "dpo@gov.uk", processDescription: "Scans employee expense reports submitted via a custom web app to check for policy compliance (e.g., meal limits, approved vendors). Flags non-compliant items for manager approval.", tech_apps: ["app_custom"], tech_workflows: ["wf_script"], tech_ai_models: [], app_other_text: "", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: false, onTenderList: false, supplierCompliant: false, dataType: "internal_10", decisionNature: "interpretive_15", accuracySlider: "92", publicFacing: false, loggingEnabled: true, appealMechanism: true, biasAssessed: true, biasTesting: false, explainability: false, humanInLoop: true, rbacInPlace: true, hasPIIRemoval: false, apiSecured: true, staffTraining: true, tech_transfer: [], encryptTransit: false, encryptRest: false },
            commercials: { initiativeName: "Commercials: Contract Risk Analysis", projectLead: "Peter Jones", responsibleOwner: "Chief Commercial Officer", dpoContact: "dpo@gov.uk", processDescription: "Uses a generative AI model to perform an initial review of draft supplier contracts, highlighting non-standard or high-risk clauses for review by the legal team.", tech_apps: ["app_sharepoint"], tech_workflows: [], tech_ai_models: ["ai_openai"], app_other_text: "", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: true, onTenderList: true, supplierCompliant: false, dataType: "commercial_25", decisionNature: "subjective_35", accuracySlider: "85", publicFacing: false, loggingEnabled: true, appealMechanism: true, biasAssessed: false, biasTesting: false, explainability: true, humanInLoop: true, rbacInPlace: true, hasPIIRemoval: false, apiSecured: false, staffTraining: false, tech_transfer: ["tf_website"], encryptTransit: true, encryptRest: true },
            estates: { initiativeName: "Estates: Predictive Maintenance", projectLead: "Susan Williams", responsibleOwner: "Director of Estates", dpoContact: "dpo@gov.uk", processDescription: "Analyzes non-personal sensor data from HVAC units across government buildings to predict potential failures and automatically schedule preventative maintenance.", tech_apps: ["app_custom"], tech_workflows: ["wf_script"], tech_ai_models: ["ai_custom"], app_other_text: "", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: true, onTenderList: true, supplierCompliant: true, dataType: "public_0", decisionNature: "objective_0", accuracySlider: "80", publicFacing: false, loggingEnabled: true, appealMechanism: false, biasAssessed: true, biasTesting: false, explainability: false, humanInLoop: false, rbacInPlace: true, hasPIIRemoval: false, apiSecured: true, staffTraining: true, tech_transfer: ["tf_sftp"], encryptTransit: true, encryptRest: true },
            hr: { initiativeName: "HR: CV Screening Assistant", projectLead: "David Chen", responsibleOwner: "Head of Recruitment", dpoContact: "dpo@gov.uk", processDescription: "Uses an AI model to perform an initial screen of CVs, ranking them against the job description. The top 20% are passed to a human recruiter for review. Aims to reduce manual screening time.", tech_apps: ["app_workday"], tech_workflows: [], tech_ai_models: ["ai_gemini"], app_other_text: "", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: true, onTenderList: true, supplierCompliant: false, dataType: "special_50", decisionNature: "subjective_35", accuracySlider: "90", publicFacing: false, loggingEnabled: true, appealMechanism: true, biasAssessed: false, biasTesting: false, explainability: false, humanInLoop: true, rbacInPlace: true, hasPIIRemoval: true, apiSecured: true, staffTraining: true, tech_transfer: ["tf_api"], encryptTransit: true, encryptRest: true },
            comms: { initiativeName: "Comms: Social Media Analysis", projectLead: "Aisha Khan", responsibleOwner: "Head of Communications", dpoContact: "dpo@gov.uk", processDescription: "Analyzes public sentiment on Twitter/X regarding a new policy announcement, classifying posts as positive, negative, or neutral to inform the communications strategy.", tech_apps: ["app_other"], tech_workflows: [], tech_ai_models: ["ai_azure"], app_other_text: "Brandwatch", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: true, onTenderList: true, supplierCompliant: true, dataType: "public_0", decisionNature: "interpretive_15", accuracySlider: "88", publicFacing: true, loggingEnabled: false, appealMechanism: false, biasAssessed: true, biasTesting: true, explainability: true, humanInLoop: true, rbacInPlace: true, hasPIIRemoval: false, apiSecured: true, staffTraining: true, tech_transfer: ["tf_api"], encryptTransit: true, encryptRest: true },
            operations: { initiativeName: "Operations: FOI Redaction Tool", projectLead: "Tom Richards", responsibleOwner: "Head of Operations", dpoContact: "dpo@gov.uk", processDescription: "An AI tool that automatically redacts PII and other sensitive information from documents before they are released under a Freedom of Information (FOI) request. All outputs are reviewed by a human.", tech_apps: ["app_custom"], tech_workflows: ["wf_script"], tech_ai_models: ["ai_custom"], app_other_text: "", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: false, onTenderList: false, supplierCompliant: false, dataType: "special_50", decisionNature: "objective_0", accuracySlider: "99", publicFacing: false, loggingEnabled: true, appealMechanism: true, biasAssessed: true, biasTesting: true, explainability: true, humanInLoop: true, rbacInPlace: true, hasPIIRemoval: true, apiSecured: true, staffTraining: true, tech_transfer: [], encryptTransit: false, encryptRest: false },
            policy: { initiativeName: "Policy: Evidence Synthesis Tool", projectLead: "Eleanor Vance", responsibleOwner: "Head of Policy", dpoContact: "dpo@gov.uk", processDescription: "A generative AI tool that ingests and summarizes academic papers, consultation responses, and reports to identify key themes and evidence for policy development. All summaries are validated by policy advisors.", tech_apps: ["app_sharepoint", "app_atlassian"], tech_workflows: ["wf_script"], tech_ai_models: ["ai_openai"], app_other_text: "", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: true, onTenderList: true, supplierCompliant: false, dataType: "internal_10", decisionNature: "interpretive_15", accuracySlider: "90", publicFacing: false, loggingEnabled: true, appealMechanism: true, biasAssessed: true, biasTesting: true, explainability: true, humanInLoop: true, rbacInPlace: true, hasPIIRemoval: false, apiSecured: true, staffTraining: true, tech_transfer: ["tf_website"], encryptTransit: true, encryptRest: true },
            it_helpdesk: { initiativeName: "IT: Helpdesk Automation", projectLead: "Ben Carter", responsibleOwner: "Head of IT Services", dpoContact: "dpo@gov.uk", processDescription: "A chatbot integrated into the staff intranet that handles first-line IT support queries like password resets and software access requests, escalating to a human agent via ServiceNow when it cannot resolve the issue.", tech_apps: ["app_servicenow"], tech_workflows: ["wf_powerautomate"], tech_ai_models: ["ai_azure"], app_other_text: "", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: true, onTenderList: true, supplierCompliant: true, dataType: "personal_30", decisionNature: "objective_0", accuracySlider: "95", publicFacing: true, loggingEnabled: true, appealMechanism: true, biasAssessed: true, biasTesting: false, explainability: false, humanInLoop: true, rbacInPlace: true, hasPIIRemoval: false, apiSecured: true, staffTraining: true, tech_transfer: ["tf_api"], encryptTransit: true, encryptRest: true },
            fraud: { initiativeName: "Fraud: Grant Anomaly Detection", projectLead: "Maria Garcia", responsibleOwner: "Head of Fraud Prevention", dpoContact: "dpo@gov.uk", processDescription: "A machine learning model analyzes grant application data to identify anomalous patterns that may indicate fraudulent activity. Flagged applications are sent for mandatory human investigation.", tech_apps: ["app_custom", "app_aws"], tech_workflows: ["wf_script"], tech_ai_models: ["ai_custom"], app_other_text: "", wf_other_text: "", ai_other_text: "", tf_other_text: "", involvesThirdParty: false, onTenderList: false, supplierCompliant: false, dataType: "special_50", decisionNature: "interpretive_15", accuracySlider: "95", publicFacing: false, loggingEnabled: true, appealMechanism: true, biasAssessed: false, biasTesting: false, explainability: true, humanInLoop: true, rbacInPlace: true, hasPIIRemoval: false, apiSecured: true, staffTraining: true, tech_transfer: ["tf_api"], encryptTransit: true, encryptRest: true },
            blank: {}
        };
        
        // --- EVENT HANDLERS ---
        
        function resetForm() {
            form.reset();
            document.querySelectorAll('.btn-selector.active').forEach(b => b.classList.remove('active'));
            document.querySelector('#dataType .btn-selector[data-value="public_0"]')?.classList.add('active');
            document.querySelector('#decisionNature .btn-selector[data-value="objective_0"]')?.classList.add('active');
            document.querySelectorAll('.other-text-input, #conditionalSupplierQuestions, #encryptionQuestions, #aiSpecificQuestions').forEach(el => el.classList.add('hidden'));
            if(templateSelector) templateSelector.value = "blank";
            updateAll();
        }

        if (clearDataBtn) {
            clearDataBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all saved data from your browser? This cannot be undone.')) {
                    localStorage.removeItem('aiAssessmentData');
                    resetForm();
                }
            });
        }
        
        if (templateSelector) {
            templateSelector.addEventListener('change', (e) => {
                const template = templates[e.target.value];
                if (e.target.value === 'blank') {
                    resetForm();
                } else if (template) {
                    loadFormData(template);
                }
            });
        }
        
        document.querySelectorAll('.btn-selector-group').forEach(group => {
            group.addEventListener('click', (e) => {
                const button = e.target.closest('.btn-selector');
                if (!button) return;
                
                if (group.classList.contains('single-select')) {
                    if(button.classList.contains('active')) return;
                    group.querySelector('.active')?.classList.remove('active');
                    button.classList.add('active');
                } else {
                    button.classList.toggle('active');
                }

                if (button.id.endsWith('_other')) {
                    const textInput = document.getElementById(button.id + '_text');
                    if (textInput) {
                        textInput.classList.toggle('hidden', !button.classList.contains('active'));
                        if (!button.classList.contains('active')) textInput.value = '';
                    }
                }
                
                if (group.id === 'tech_ai_models') {
                    const isAiSelected = group.querySelector('.btn-selector.active');
                    aiSpecificQuestions.classList.toggle('hidden', !isAiSelected);
                }
                updateAll();
            });
        });
        
        if (techTransferGroup) {
            techTransferGroup.addEventListener('click', () => {
                const anyActive = techTransferGroup.querySelector('.btn-selector.active');
                encryptionQuestions.classList.toggle('hidden', !anyActive);
                if(!anyActive) {
                    document.getElementById('encryptTransit').checked = false;
                    document.getElementById('encryptRest').checked = false;
                }
            });
        }
        
        if (involvesThirdPartySwitch) {
            involvesThirdPartySwitch.addEventListener('change', () => {
                conditionalSupplierQuestions.classList.toggle('hidden', !involvesThirdPartySwitch.checked);
                if(!involvesThirdPartySwitch.checked) {
                    document.getElementById('onTenderList').checked = false;
                    document.getElementById('supplierCompliant').checked = false;
                }
                updateAll();
            });
        }

        function updateSliderTrack(el) { if (!el) return; const value = (el.value - el.min) / (el.max - el.min) * 100; el.style.setProperty('--gradient-stop', `${value}%`); }
        if (accuracySlider && accuracyInput) { accuracySlider.addEventListener('input', (e) => { accuracyInput.value = e.target.value; updateSliderTrack(e.target); }); accuracyInput.addEventListener('input', (e) => { accuracySlider.value = e.target.value; updateSliderTrack(accuracySlider); }); }
        
        document.querySelectorAll('.help-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                const helpText = icon.closest('.form-group').querySelector('.help-text');
                if (helpText) helpText.classList.toggle('hidden');
            });
        });

        if (openModalBtn) openModalBtn.addEventListener('click', () => scoreModal.classList.remove('hidden'));
        if (closeModalBtn) closeModalBtn.addEventListener('click', () => scoreModal.classList.add('hidden'));
        if (scoreModal) scoreModal.addEventListener('click', (e) => { if (e.target === scoreModal) scoreModal.classList.add('hidden'); });

        if (openTransparencyModalBtn) openTransparencyModalBtn.addEventListener('click', () => transparencyModal.classList.remove('hidden'));
        if (transparencyModalCloseBtn) transparencyModalCloseBtn.addEventListener('click', () => transparencyModal.classList.add('hidden'));
        if (transparencyModal) transparencyModal.addEventListener('click', (e) => { if (e.target === transparencyModal) transparencyModal.classList.add('hidden'); });

        if(generatePromptBtn) {
            generatePromptBtn.addEventListener('click', () => {
                const promptText = generateRISENPrompt();
                if(promptDisplay) promptDisplay.textContent = promptText;
                if(promptModal) promptModal.classList.remove('hidden');
            });
        }

        if(copyPromptBtn) {
            copyPromptBtn.addEventListener('click', () => {
                if(promptDisplay && navigator.clipboard) {
                    navigator.clipboard.writeText(promptDisplay.textContent).then(() => {
                        copyPromptBtn.querySelector('span').textContent = 'Copied!';
                        setTimeout(() => {
                            copyPromptBtn.querySelector('span').textContent = 'Copy to Clipboard';
                        }, 2000);
                    });
                }
            });
        }
        if(promptModalCloseBtn) promptModalCloseBtn.addEventListener('click', () => promptModal.classList.add('hidden'));

        // --- CORE LOGIC & FUNCTIONS ---

        function calculateRisk() {
            let score = 5; 
            const breakdown = [{ factor: 'Inherent Project Baseline', points: 5, type: 'risk' }]; 
            const data = getFormData();
            const isAiProject = data.tech_ai_models.length > 0;
            
            if (isAiProject) { score += 15; breakdown.push({ factor: 'Inherent Risk (AI Model Usage)', points: 15, type: 'risk' }); }
            if (data.tech_workflows.length > 0) { score += 5; breakdown.push({ factor: 'Inherent Risk (Workflow/RPA Usage)', points: 5, type: 'risk' }); }
            if (data.tech_transfer.length > 0) { score += 10; breakdown.push({ factor: 'Inherent Risk (Data Transfer)', points: 10, type: 'risk' }); }
            
            const dataTypeBtn = document.querySelector('#dataType .btn-selector.active'); 
            let dataSensitivityRisk = 0; 
            if (dataTypeBtn) { const [risk] = dataTypeBtn.dataset.value.split('_').slice(-1); dataSensitivityRisk = parseInt(risk); if (dataSensitivityRisk > 0) breakdown.push({ factor: `Data Sensitivity (${dataTypeBtn.textContent.trim()})`, points: dataSensitivityRisk, type: 'risk' }); }
            
            let decisionNatureRisk = 0; 
            if (isAiProject) {
                const decisionNatureBtn = document.querySelector('#decisionNature .btn-selector.active'); 
                if (decisionNatureBtn) { const [risk] = decisionNatureBtn.dataset.value.split('_').slice(-1); decisionNatureRisk = parseInt(risk); if (decisionNatureRisk > 0) breakdown.push({ factor: `Decision Nature (${decisionNatureBtn.textContent.trim()})`, points: decisionNatureRisk, type: 'risk' }); }
            }
            
            score += dataSensitivityRisk + decisionNatureRisk;
            
            if (isAiProject) {
                if (dataSensitivityRisk >= 50 && decisionNatureRisk >= 30 && !data.humanInLoop) { const amplifiedRisk = 40; score += amplifiedRisk; breakdown.push({ factor: 'CRITICAL Amplifier: Special Category Data for subjective decisions without human oversight', points: amplifiedRisk, type: 'risk' }); }
                else if (decisionNatureRisk >= 30 && !data.humanInLoop) { const amplifiedRisk = 30; score += amplifiedRisk; breakdown.push({ factor: 'Amplified Risk: Subjective decisions without Human-in-the-Loop oversight', points: amplifiedRisk, type: 'risk' }); }
                if (decisionNatureRisk >= 30 && !data.explainability) { const amplifiedRisk = 15; score += amplifiedRisk; breakdown.push({ factor: 'Amplified Risk: Subjective decisions without explainability methods', points: amplifiedRisk, type: 'risk' }); }
            }
            
            if (dataSensitivityRisk >= 30 && !data.rbacInPlace) { const amplifiedRisk = 25; score += amplifiedRisk; breakdown.push({ factor: 'Amplified Risk: Sensitive data without Role-Based Access Control', points: amplifiedRisk, type: 'risk' }); }
            if (dataSensitivityRisk >= 30 && !data.encryptRest) { const amplifiedRisk = 20; score += amplifiedRisk; breakdown.push({ factor: 'Amplified Risk: Sensitive data not encrypted at rest', points: amplifiedRisk, type: 'risk' }); }
            if (data.tech_transfer.includes('tf_api') && dataSensitivityRisk >= 25 && !data.apiSecured) { const amplifiedRisk = 25; score += amplifiedRisk; breakdown.push({ factor: 'CRITICAL Amplifier: Sensitive data transfer via unsecured API', points: amplifiedRisk, type: 'risk' }); }

            if (data.involvesThirdParty) { 
                score += 10; breakdown.push({ factor: 'Inherent Risk (Third-Party)', points: 10, type: 'risk' }); 
                if (!data.onTenderList) { score += 20; breakdown.push({ factor: 'High Risk: Supplier is not on an approved framework', points: 20, type: 'risk' }); }
                if (!data.supplierCompliant) { score += 40; breakdown.push({ factor: 'High Risk: Supplier not confirmed policy-compliant', points: 40, type: 'risk' }); }
            }
            
            if (isAiProject) {
                const accuracyRisk = Math.round((data.accuracySlider - 50) * 0.3); if(accuracyRisk > 0) { score += accuracyRisk; breakdown.push({ factor: `High Accuracy Requirement (${data.accuracySlider}%)`, points: accuracyRisk, type: 'risk' }); }
                if (!data.publicFacing) { score += 25; breakdown.push({ factor: 'GCS Risk: Users not notified of AI interaction', points: 25, type: 'risk' }); }
                if (!data.biasAssessed) { score += 15; breakdown.push({ factor: 'Risk: Source data not assessed for bias', points: 15, type: 'risk' }); }
                if (!data.biasTesting) { score += 20; breakdown.push({ factor: 'High Risk: Model not tested for fairness', points: 20, type: 'risk' }); }
            }
            
            document.querySelectorAll('#tech_transfer .btn-selector.active[data-risk]').forEach(el => { const risk = parseInt(el.dataset.risk); score += risk; breakdown.push({ factor: `Insecure Transfer (${el.textContent.trim()})`, points: risk, type: 'risk' }); });

            form.querySelectorAll('input[type=checkbox][data-mitigation]').forEach(el => { 
                const isAiControl = el.closest('#aiSpecificQuestions');
                if( (isAiProject && isAiControl) || !isAiControl ) {
                    if (el.checked) { 
                        const points = -parseInt(el.dataset.mitigation); 
                        score += points; 
                        const label = el.closest('.switch-container').querySelector('.label-group label').textContent; 
                        breakdown.push({ factor: label, points: points, type: 'mitigation' }); 
                    }
                }
            });
            
            const totalScore = Math.max(0, Math.min(100, Math.round(score))); 
            return { score: totalScore, breakdown };
        }

        function populateScoreModal(breakdown) { const tbody = document.getElementById('score-breakdown-body'); if (!tbody) return; tbody.innerHTML = ''; let total = 0; breakdown.forEach(item => { const row = tbody.insertRow(); row.insertCell().textContent = item.factor; const pointsCell = row.insertCell(); pointsCell.textContent = item.points > 0 ? `+${item.points}` : item.points; row.className = item.type === 'risk' ? 'risk-item' : 'mitigation-item'; total += item.points; }); const totalCell = document.getElementById('total-score-cell'); if (totalCell) totalCell.textContent = Math.max(0, Math.min(100, total)); }
        function updateRiskMeter(score) { const scoreEl = document.getElementById('risk-score'); const levelEl = document.getElementById('risk-level'); const indicatorEl = document.getElementById('risk-indicator'); if (!scoreEl || !levelEl || !indicatorEl) return; scoreEl.textContent = score; indicatorEl.style.left = `${score}%`; levelEl.className = 'risk-level'; if (score < 40) { levelEl.textContent = 'LOW'; levelEl.classList.add('risk-low'); } else if (score < 70) { levelEl.textContent = 'MODERATE'; levelEl.classList.add('risk-medium'); } else { levelEl.textContent = 'HIGH'; levelEl.classList.add('risk-high'); } }
        
        function saveToLocalStorage() { localStorage.setItem('aiAssessmentData', JSON.stringify(getFormData())); }
        function updateAll() { const { score, breakdown } = calculateRisk(); updateRiskMeter(score); populateScoreModal(breakdown); saveToLocalStorage(); }

        function getFormData() {
            const formData = new FormData(form); const data = Object.fromEntries(formData.entries()); form.querySelectorAll('input[type=checkbox]').forEach(el => data[el.id] = el.checked); data.dataType = document.querySelector('#dataType .btn-selector.active')?.dataset.value; data.decisionNature = document.querySelector('#decisionNature .btn-selector.active')?.dataset.value; data.tech_apps = Array.from(document.querySelectorAll('#tech_apps .btn-selector.active')).map(b => b.id); data.tech_workflows = Array.from(document.querySelectorAll('#tech_workflows .btn-selector.active')).map(b => b.id); data.tech_ai_models = Array.from(document.querySelectorAll('#tech_ai_models .btn-selector.active')).map(b => b.id); data.tech_transfer = Array.from(document.querySelectorAll('#tech_transfer .btn-selector.active')).map(b => b.id); return data;
        }

        function loadFormData(data) {
            form.reset();
            Object.keys(data).forEach(key => { if (typeof data[key] !== 'object' && !Array.isArray(data[key])) { const el = form.elements[key]; if (el) { if (el.type === 'checkbox') el.checked = data[key]; else if (el.type === 'range') el.value = data[key]; else el.value = data[key]; } } });
            document.querySelector('#dataType .active')?.classList.remove('active'); if(data.dataType) document.querySelector(`#dataType .btn-selector[data-value="${data.dataType}"]`)?.classList.add('active');
            document.querySelector('#decisionNature .active')?.classList.remove('active'); if(data.decisionNature) document.querySelector(`#decisionNature .btn-selector[data-value="${data.decisionNature}"]`)?.classList.add('active');
            ['tech_apps', 'tech_workflows', 'tech_ai_models', 'tech_transfer'].forEach(category => { document.querySelectorAll(`#${category} .btn-selector`).forEach(button => button.classList.remove('active')); if (data[category]) { data[category].forEach(id => document.getElementById(id)?.classList.add('active')); } });
            ['app_other', 'wf_other', 'ai_other', 'tf_other'].forEach(id => { const button = document.getElementById(id); const textInput = document.getElementById(id + '_text'); if (button && textInput) textInput.classList.toggle('hidden', !button.classList.contains('active')); });
            conditionalSupplierQuestions.classList.toggle('hidden', !data.involvesThirdParty); encryptionQuestions.classList.toggle('hidden', !(data.tech_transfer && data.tech_transfer.length > 0));
            aiSpecificQuestions.classList.toggle('hidden', !(data.tech_ai_models && data.tech_ai_models.length > 0));
            if(accuracyInput) accuracyInput.value = data.accuracySlider || 95;
            updateSliderTrack(accuracySlider); updateAll();
        }
        
        function loadFromLocalStorage() { const savedData = localStorage.getItem('aiAssessmentData'); if (savedData) { try { loadFormData(JSON.parse(savedData)); } catch(e) { console.error("Could not load saved data:", e); localStorage.removeItem('aiAssessmentData'); } } }
        
        if (exportBtn) exportBtn.addEventListener('click', () => { const data = getFormData(); const jsonString = JSON.stringify(data, null, 2); const blob = new Blob([jsonString], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const initiativeName = data.initiativeName || 'assessment'; a.download = `${initiativeName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); });
        if (importBtn) importBtn.addEventListener('click', () => importInput.click());
        if (importInput) importInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { loadFormData(JSON.parse(event.target.result)); templateSelector.value = "blank"; } catch (err) { alert('Error: Could not parse JSON file.'); console.error(err); } }; reader.readAsText(file); e.target.value = ''; });

        function generateRISENPrompt() {
            const data = getFormData();
            const { score, breakdown } = calculateRisk();
            const technologies = [...data.tech_apps, ...data.tech_workflows, ...data.tech_ai_models].map(id => document.getElementById(id)?.textContent.trim()).filter(Boolean).join(', ');
            const dataType = document.querySelector('#dataType .btn-selector.active')?.textContent.trim() || 'Not specified';
            const decisionNature = document.querySelector('#decisionNature .btn-selector.active')?.textContent.trim() || 'Not specified';
            
            return `ROLE (R):
You are a specialist in digital transparency for the UK Government, expert in explaining complex technical processes to a non-technical audience in accordance with GDS (Government Digital Service) standards.

INSTRUCTION (I):
Your task is to generate an AI/Automation Transparency Report in HTML format based on the provided assessment data. The report should be written in clear, simple language (plain English) suitable for the public. It must use UK English spelling and be formatted as a GDS-style dashboard with distinct cards.

STEPS (S):
1. Review the assessment data provided below.
2. Create a main heading: 'AI and Automation in our Services: Transparency Report'.
3. Create a 'Project Overview' card. Include the 'Initiative Name' and a summary of the 'Process Description' in plain English.
4. Create a 'How it Works' card. List the key technologies involved.
5. Create a 'Data We Use' card. Explain the type of data used (e.g., 'This service uses personal data to function...'). State clearly if PII removal is used.
6. Create a 'How Decisions are Made' card. Explain the nature of the decision-making. Crucially, state clearly if a 'Human-in-the-Loop' is involved to review decisions.
7. Create an 'Accountability' card. State clearly if there is an 'Appeal Mechanism' and if decisions are 'Logged for Audit'.
8. Format the output as a dashboard using divs with a 'card' class. Use GDS-style classes for headings and text.

END GOAL (E):
The final output should be a standalone HTML file that clearly and honestly explains how this automated system works to the public, building trust through transparency.

NARROWING (N):
- Use plain English and avoid technical jargon. The primary audience is the general public.
- Only provide the HTML code in a single block. Do not add any information not present in the assessment data.
- Ensure all spelling is UK English (e.g., 'organisation', 'summarise').

--- ASSESSMENT DATA ---
Initiative Name: ${data.initiativeName || 'Not Provided'}
Process Description: ${data.processDescription || 'Not Provided'}
Technologies Used: ${technologies || 'Not specified'}
Data Sensitivity: ${dataType}
PII Removal Used: ${data.hasPIIRemoval ? 'Yes' : 'No'}
Nature of Decision-Making: ${data.tech_ai_models.length > 0 ? decisionNature : 'Standard automated rules'}
Human-in-the-Loop: ${data.humanInLoop ? 'Yes, key decisions are reviewed by a person.' : 'No, the process is fully automated.'}
Appeal Mechanism: ${data.appealMechanism ? 'Yes, a process exists to appeal decisions.' : 'No'}
Decisions Logged for Audit: ${data.loggingEnabled ? 'Yes' : 'No'}

--- ONE-SHOT EXAMPLE OF DESIRED HTML FORMAT ---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Transparency Report</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #F3F2F1; padding: 20px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background-color: #FFFFFF; border: 1px solid #B1B4B6; padding: 20px; }
        .govuk-heading-l { font-size: 2.25rem; font-weight: 700; border-bottom: 5px solid #1D70B8; padding-bottom: 10px; margin-bottom: 30px;}
        .govuk-heading-m { font-size: 1.5rem; font-weight: 700; margin-top: 0; }
        .govuk-body { font-size: 1.1rem; line-height: 1.5; }
    </style>
</head>
<body>
    <h1 class="govuk-heading-l">AI and Automation in our Services: Transparency Report</h1>
    <div class="dashboard">
        <div class="card">
            <h2 class="govuk-heading-m">Project Overview</h2>
            <p class="govuk-body"><strong>Initiative Name:</strong> [AI summarises name here]</p>
            <p class="govuk-body">[AI summarises process description here in plain English.]</p>
        </div>
        <div class="card">
            <h2 class="govuk-heading-m">How it Works</h2>
            <p class="govuk-body">This process uses the following types of technology: [AI lists technologies here].</p>
        </div>
        <div class="card">
            <h2 class="govuk-heading-m">Data We Use</h2>
            <p class="govuk-body">[AI explains data sensitivity here.]</p>
        </div>
        <div class="card">
            <h2 class="govuk-heading-m">How Decisions are Made</h2>
            <p class="govuk-body">[AI explains decision nature and human oversight here.]</p>
        </div>
        <div class="card">
            <h2 class="govuk-heading-m">Accountability</h2>
            <p class="govuk-body">[AI explains appeal and logging mechanisms here.]</p>
        </div>
    </div>
</body>
</html>`;
        }

        if (generatePdfBtn) {
            generatePdfBtn.addEventListener('click', () => {
                const data = getFormData(); const { score, breakdown } = calculateRisk();
                if (!data.initiativeName || !data.responsibleOwner) { alert('Please enter an Initiative Name and a Responsible Owner before generating a certificate.'); return; }
                document.getElementById('certDate').textContent = new Date().toLocaleDateString('en-GB');
                document.getElementById('certInitiativeName').textContent = data.initiativeName; document.getElementById('certProcessDescription').textContent = data.processDescription; document.getElementById('certProjectLead').textContent = data.projectLead; document.getElementById('certResponsibleOwner').textContent = data.responsibleOwner; document.getElementById('certDpoContact').textContent = data.dpoContact;
                let techHTML = '<ul>'; document.querySelectorAll('#tech_apps .active, #tech_workflows .active, #tech_ai_models .active, #tech_transfer .active').forEach(el => { let label = el.textContent.trim(); if(el.id.endsWith('_other')) { label += `: ${document.getElementById(el.id + '_text').value || 'Not specified'}`; } techHTML += `<li>${label}</li>`; }); techHTML += '</ul>'; if (techHTML === '<ul></ul>') techHTML = '<p>No specific technologies listed.</p>';
                document.querySelector('#certTechStack').innerHTML = `<h3>Technology & Data Transfer</h3>${techHTML}`;
                const certLevelEl = document.getElementById('certScoreLevel'); const currentLevelEl = document.getElementById('risk-level'); certLevelEl.textContent = `${currentLevelEl.textContent} (${score}/100)`; certLevelEl.className = 'certScoreLevel ' + currentLevelEl.classList.toString();
                const rationaleListEl = document.getElementById('certRationaleList'); rationaleListEl.innerHTML = ''; breakdown.forEach(item => { const li = document.createElement('li'); li.innerHTML = `<strong>${item.factor} (${item.points > 0 ? '+' : ''}${item.points} pts):</strong> Contributes as a ${item.type} factor.`; rationaleListEl.appendChild(li); });
                const certTemplate = document.getElementById('certificateTemplate'); certTemplate.style.display = 'block';
                html2canvas(certTemplate, { scale: 2 }).then(canvas => {
                    certTemplate.style.display = 'none'; const imgData = canvas.toDataURL('image/jpeg', 0.9); const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
                    const filename = `${data.initiativeName.replace(/\s+/g, '_')}-${new Date().toISOString().slice(0,10)}.pdf`; pdf.save(filename);
                });
            });
        }

        // --- INITIAL LOAD ---
        loadFromLocalStorage();
        updateAll();
        if(form) form.addEventListener('input', updateAll);
    });
    </script>
</body>
</html>
